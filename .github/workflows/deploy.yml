name: Deploy with Docker Hub

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # 1. 프론트/백엔드 빌드 (기존 동일)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend and Copy to Backend
        run: |
          cd frontend
          npm install
          npm run build
          if [ -d "dist" ]; then BUILD_DIR="dist"; elif [ -d "build" ]; then BUILD_DIR="build"; else exit 1; fi
          mkdir -p ../backend/src/main/resources/static
          rm -rf ../backend/src/main/resources/static/*
          cp -r $BUILD_DIR/* ../backend/src/main/resources/static/

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test

      # 2. Docker Hub 로그인 & 이미지 Push (기존 동일)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/my-server:latest

      # -------------------------------------------------------------
      # 이미지는 도커 허브에서 받지만, 설정 파일은 직접 덮어씌워야 합니다.
      # -------------------------------------------------------------
      - name: Copy config files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          # JAR 파일은 이제 안 보냅니다! 설정 파일만 보냅니다.
          source: "docker-compose.yml,nginx,setup-database.sql,insert-default-data.sql"
          target: "/home/dev/my-platform"
          strip_components: 0

      # 4. 서버 배포 실행 (기존 동일)
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            
            # 이제 방금 SCP로 덮어쓴 docker-compose.yml을 사용합니다.
            cd /home/dev/my-platform
            
            docker pull ${{ secrets.DOCKER_USERNAME }}/my-server:latest
            docker compose down
            docker compose up -d
            docker image prune -f