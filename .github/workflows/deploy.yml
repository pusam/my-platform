name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # 1. Node.js ì„¸íŒ…
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ê°•ì œ ë³µì‚¬ (ìˆ˜ì •ëœ ë¶€ë¶„ â­)
      - name: Build Frontend and Copy to Backend
        run: |
          echo "ðŸš§ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì‹œìž‘..."
          cd frontend
          npm install
          npm run build
          
          echo "ðŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸ ì¤‘..."
          # dist í´ë”ê°€ ìžˆìœ¼ë©´ distë¥¼ ì“°ê³ , buildê°€ ìžˆìœ¼ë©´ buildë¥¼ ì”€ (ìžë™ ê°ì§€)
          if [ -d "dist" ]; then
            BUILD_DIR="dist"
          elif [ -d "build" ]; then
            BUILD_DIR="build"
          else
            echo "âŒ ì—ëŸ¬: ë¹Œë“œ í´ë”(dist ë˜ëŠ” build)ê°€ ì—†ìŠµë‹ˆë‹¤! ë¹Œë“œ ì‹¤íŒ¨."
            exit 1
          fi
          
          echo "âœ… ê°ì§€ëœ ë¹Œë“œ í´ë”: $BUILD_DIR"
          
          # ë°±ì—”ë“œ static í´ë” ë§Œë“¤ê¸°
          mkdir -p ../backend/src/main/resources/static
          
          # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ (ê¹¨ë—í•˜ê²Œ)
          rm -rf ../backend/src/main/resources/static/*
          
          # íŒŒì¼ ë³µì‚¬
          cp -r $BUILD_DIR/* ../backend/src/main/resources/static/
          
          # ë³µì‚¬ ìž˜ ëëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ (ë¡œê·¸ì— ì°íž˜)
          echo "ðŸ“¦ ë³µì‚¬ëœ íŒŒì¼ ëª©ë¡ í™•ì¸:"
          ls -F ../backend/src/main/resources/static/

      # 3. ìžë°” ì„¸íŒ…
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test

      # 5. íŒŒì¼ ì „ì†¡
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          source: "backend/build/libs/*.jar,docker-compose.yml,Dockerfile,nginx,setup-database.sql,insert-default-data.sql"
          target: "/home/dev/my-platform"
          strip_components: 0

      # 6. ì„œë²„ ìž¬ì‹œìž‘
      - name: Restart Docker Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.KEY }}
          script: |
            cd /home/dev/my-platform
            mv backend/build/libs/*.jar app.jar 2>/dev/null || true
            rm -rf backend
            docker compose down
            docker compose up -d --build
            docker image prune -f